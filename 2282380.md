# ã€å›¾åƒåˆ†ç±»ã€‘ä½¿ç”¨é£æ¡¨å…¨æµç¨‹å¼€å‘å·¥å…·PaddleXå®ç°åƒåœ¾åˆ†ç±»ä»»åŠ¡

## ä¸€ã€å‰è¨€

* éšç€äººä»¬ä¿æŠ¤ç¯å¢ƒçš„æ„è¯†é€æ¸å¢å¼ºï¼Œåƒåœ¾åˆ†ç±»æˆä¸ºæ¯ä¸€ä¸ªäººçš„å…±è¯†ã€‚ä½†æ˜¯ç¹æ‚çš„åƒåœ¾ç§ç±»å¤ªéš¾è®°äº†ï¼Œäºæ˜¯è‡ªå·±æƒ³ä½¿ç”¨PPå¼€å‘ä¸€ä¸ªæ¨¡å‹èƒ½æ›¿æˆ‘å®Œæˆåƒåœ¾åˆ†ç±»çš„å·¥å…·ã€‚ä½†æ˜¯AI Studioå®ç°åƒåœ¾åˆ†ç±»çš„é¡¹ç›®æ¯”æ¯”çš†æ˜¯ï¼Œäºæ˜¯æˆ‘æƒ³åˆ°ä½¿ç”¨PaddleXæ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚
* æœ¬é¡¹ç›®ç²—æš´åœ°å°†åƒåœ¾æŒ‰äººä»¬æœ€ç†Ÿæ‚‰çš„æ ‡å‡†åˆ†ä¸ºå¯å›æ”¶åƒåœ¾ã€é¤ä½™åƒåœ¾ã€æœ‰å®³åƒåœ¾å’Œå…¶ä»–åƒåœ¾å››ç§ï¼Œä½¿ç”¨é›†é£æ¡¨æ ¸å¿ƒæ¡†æ¶ã€æ¨¡å‹åº“ã€å·¥å…·åŠç»„ä»¶ç­‰æ·±åº¦å­¦ä¹ å¼€å‘æ‰€éœ€å…¨éƒ¨èƒ½åŠ›äºä¸€èº«çš„PaddleXå®ç°åƒåœ¾çš„å›¾åƒåˆ†ç±»ä»»åŠ¡ã€‚
* æœ¬é¡¹ç›®çš„æ•°æ®é›†å’Œæ¨¡å‹å¯ä»¥æ ¹æ®ä¸‹é¢çš„æç¤ºæ“ä½œæ¢æˆå¤§å®¶è‡ªå·±çš„ï¼Œç„¶åå¿«é€Ÿå®ç°è‡ªå·±å›¾åƒåˆ†ç±»é¡¹ç›®çš„å¼€å‘ã€‚

## äºŒã€å‡†å¤‡å·¥ä½œ



```python
# ä¸‹é¢çš„å‘½ä»¤ç”¨äºé‡æ–°è¿è¡Œé¡¹ç›®æ—¶åˆ é™¤å‰ä¸€æ¬¡çš„æ®‹ç•™æ–‡ä»¶
#!rm -rf output
#!rm -rf work/*
#!rm -rf inference_model
```

### å®‰è£…ä¾èµ–


```python
# ä»ç™¾åº¦é•œåƒå®‰è£…PaddleX
!pip install paddlex -i https://mirror.baidu.com/pypi/simple
```

### å…³äºæ•°æ®

> ç”±äºè‡ªå·±å¤ªæ‡’äº†ï¼Œæ‰€ä»¥æœ¬é¡¹ç›®çš„æ•°æ®é›†å°†æ•°æ®é›†[åƒåœ¾åˆ†ç±»å›¾ç‰‡](https://aistudio.baidu.com/aistudio/datasetdetail/35095)é­”æ”¹æˆå››ç±»ï¼Œç”Ÿæˆå››ä¸ªæ–‡ä»¶å¤¹æ”¾åœ¨æ•°æ®é›†æ ¹ç›®å½•ä¸‹ã€‚

> å¤§å®¶å¯ä»¥è·Ÿç€ä¸‹é¢çš„æ“ä½œæŒ‡å¼•ï¼Œæ¢æˆè‡ªå·±çš„æ•°æ®é›†ä»¥åŠå¯¹è‡ªå·±çš„æ•°æ®é›†è¿›è¡Œæ•°æ®å¢å¼º


```python
# è§£å‹æ•°æ®é›†ï¼Œæ”¾åœ¨workä¸‹ä½¿å…¶å¯ä»¥æ°¸ä¹…ä¿å­˜ï¼ˆå¦‚æœæ¢æ•°æ®é›†æºè®°å¾—æ›´æ”¹ä¸‹é¢çš„è·¯å¾„ï¼‰
!unzip -oq /home/aistudio/data/data104285/Waste.zip -d work/
```


```python
# æŸ¥çœ‹æ•°æ®é›†æ–‡ä»¶ç»“æ„
!tree work/Waste -L 1
```

    work/Waste
    â”œâ”€â”€ FoodWaste
    â”œâ”€â”€ HarmfulWaste
    â”œâ”€â”€ OtherWaste
    â””â”€â”€ RecyclableWaste
    
    4 directories, 0 files



```python
# ä½¿ç”¨PaddleXåˆ’åˆ†æ•°æ®é›†
# APIè¯´æ˜ https://paddlex.readthedocs.io/zh_CN/release-1.3/data/annotation/classification.html
# ä¸‹åˆ—å‚æ•°dataset_diråé¢å¯æ”¹æˆè‡ªå·±çš„æ•°æ®é›†è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰
!paddlex --split_dataset --format ImageNet --dataset_dir work/Waste --val_value 0.2 --test_value 0.1
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/setuptools/depends.py:2: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
      import imp
    Dataset Split Done.[0m
    [0mTrain samples: 10084[0m
    [0mEval samples: 2879[0m
    [0mTest samples: 1439[0m
    [0mSplit files saved in work/Waste[0m
    [0m[0m


```python
import paddlex as pdx
from paddlex.cls import transforms
# æ•°æ®å¢å¼ºï¼šå®šä¹‰è®­ç»ƒå’ŒéªŒè¯æ—¶çš„transforms
# APIè¯´æ˜ https://paddlex.readthedocs.io/zh_CN/release-1.3/apis/transforms/cls_transforms.html
train_transforms = transforms.Compose([
    # å›¾åƒé¢„å¤„ç†ä»£ç ï¼šéšæœºæ°´å¹³ç¿»è½¬ã€éšæœºå‚ç›´ç¿»è½¬ã€éšæœºæ—‹è½¬ã€æ ‡å‡†åŒ–
    transforms.RandomHorizontalFlip(),
    transforms.RandomVerticalFlip(),
    transforms.RandomRotate(),
    transforms.Normalize()
])

eval_transforms = transforms.Compose([
    transforms.RandomHorizontalFlip(),
    transforms.RandomVerticalFlip(),
    transforms.RandomRotate(),
    transforms.Normalize()
])

# æ•°æ®é›†è¯»å–
# APIè¯´æ˜ https://paddlex.readthedocs.io/zh_CN/release-1.3/apis/datasets.html
# pathä¸ºæ•°æ®é›†æ‰€åœ¨ç›®å½•è·¯å¾„ï¼Œå¯æ”¹æˆè‡ªå·±çš„æ•°æ®é›†è·¯å¾„
path = 'work/Waste'
train_dataset = pdx.datasets.ImageNet(
                    data_dir= path,
                    file_list= path + '/train_list.txt',
                    label_list= path + '/labels.txt',
                    transforms=train_transforms)
eval_dataset = pdx.datasets.ImageNet(
                    data_dir= path,
                    file_list= path + '/val_list.txt',
                    label_list= path + '/labels.txt',
                    transforms=eval_transforms)
```

    2021-08-15 15:02:59 [INFO]	Starting to read file list from dataset...
    2021-08-15 15:03:00 [INFO]	10084 samples in file work/Waste/train_list.txt
    2021-08-15 15:03:00 [INFO]	Starting to read file list from dataset...
    2021-08-15 15:03:00 [INFO]	2879 samples in file work/Waste/val_list.txt


## ä¸‰ã€æ¨¡å‹é€‰æ‹©

è¿™é‡Œé€‰æ‹©ç§»åŠ¨ç«¯æ¨¡å‹MobileNetV3ä½œä¸ºå¼€å‘æ¨¡å‹

> MobileNetV3æ˜¯åœ¨MobileNetV2çš„åŸºç¡€ä¸Šæå‡ºçš„ç½‘ç»œï¼Œå…¶è®¡ç®—é‡å°ã€å‚æ•°å°‘ï¼Œç›¸æ¯”å…¶ä»–è½»é‡çº§ç½‘ç»œï¼Œä¾ç„¶å–å¾—äº†è¾ƒå¥½çš„æˆç»©ï¼›åŒæ—¶ä»¥ResNeXt101_32x16d_wslä¸ºteacheræ¨¡å‹ï¼Œè¿ç”¨SSLDï¼ˆç®€å•çš„åŠç›‘ç£æ ‡ç­¾çŸ¥è¯†è’¸é¦ï¼‰æ–¹å¼è’¸é¦å‡ºMobileNetV3_largeæ¨¡å‹ï¼Œä½œä¸ºé¢„è®­ç»ƒæ¨¡å‹ï¼›ç›¸å¯¹æ¯”åŸæœ‰çš„MobileNetV3é¢„è®­ç»ƒæ¨¡å‹ï¼Œåœ¨å‚æ•°é‡ä¸å˜çš„æƒ…å†µä¸‹ï¼ŒMobileNetV3_ssldé¢„è®­ç»ƒæ¨¡å‹åœ¨ImageNetæ•°æ®é›†ä¸Šçš„ç²¾åº¦æå‡3%ï¼Œæœ‰åŠ©äºç”¨æˆ·è¿›ä¸€æ­¥æå‡åœ¨è‡ªå®šä¹‰æ•°æ®é›†ä¸Šæ¨¡å‹è®­ç»ƒçš„æ•ˆæœã€‚


```python
# è®¾ç½®ä½¿ç”¨0å·GPUå¡ï¼ˆå¦‚æ— GPUï¼Œæ‰§è¡Œæ­¤ä»£ç åä»ç„¶ä¼šä½¿ç”¨CPUè®­ç»ƒæ¨¡å‹ï¼‰
import matplotlib
matplotlib.use('Agg') 
import os
os.environ['CUDA_VISIBLE_DEVICES'] = '0'
```

### æ¨¡å‹è®­ç»ƒ
> æ³¨ï¼š`model.train()`æ¯æ¬¡è¿è¡Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œéœ€è¦å¤šæ¬¡ä½¿ç”¨æ—¶å¾—é‡å¯ç¯å¢ƒï¼›è®¾ç½®`train_batch_size`é»˜è®¤æ˜¯32ï¼Œå¯ä»¥æ ¹æ®æ¨¡å‹å¤§å°è®¾ç½®ï¼Œä½†æ˜¯è®¾å¤ªå¤§å®¹æ˜“çˆ†å†…å­˜


```python
# APIè¯´æ˜ https://paddlex.readthedocs.io/zh_CN/release-1.3/apis/models/classification.html
num_classes = len(train_dataset.labels)
# modelå¯æ ¹æ®ä¸Šé¢é“¾æ¥æ¢æˆåˆ«çš„æ¨¡å‹ï¼ˆæ³¨æ„ä¿®æ”¹æ¨¡å‹å‚æ•°å’Œmodel.trainçš„æ¨¡å‹è¾“å‡ºè·¯å¾„ï¼‰
model = pdx.cls.MobileNetV3_large_ssld(num_classes=num_classes)
# model.trainå‚æ•°å¯å‚è€ƒä¸Šé¢çš„é“¾æ¥
model.train(num_epochs=1,
            train_dataset=train_dataset,
            train_batch_size=16,
            eval_dataset=eval_dataset,
            lr_decay_epochs=[6, 8],
            save_interval_epochs=1,
            learning_rate=0.00625,
            save_dir='output/mobilenetv3_large_ssld',
            use_vdl=True)
```

## å››ã€æ•ˆæœå±•ç¤º




```python
import paddlex as pdx
# æ¨¡å‹è½½å…¥ï¼ˆè®°å¾—æ ¹æ®æ¨¡å‹ä¿®æ”¹è·¯å¾„ï¼‰
model = pdx.load_model('output/mobilenetv3_large_ssld/best_model')
# ä½¿ç”¨æ•°æ®é›†æ–‡ä»¶å¤¹ä¸‹test.txtä¸­çš„ä¸€å¼ å›¾ç‰‡è¿›è¡Œé¢„æµ‹ï¼Œæ‰“å°é¢„æµ‹ç»“æœï¼ˆéœ€è¦æ ¹æ®æ•°æ®é›†ä¿®æ”¹è·¯å¾„ï¼‰
image_name = 'work/Waste/RecyclableWaste/img_11129.jpg'
result = model.predict(image_name)
print("Predict Result:", result)
```

    2021-08-15 14:03:25 [INFO]	Model[MobileNetV3_large_ssld] loaded.
    Predict Result: [{'category_id': 3, 'category': 'RecyclableWaste', 'score': 0.9998091}]


## äº”ã€æ¨¡å‹å¯¼å‡º


```python
# æ¨¡å‹è·¯å¾„éœ€è¦æ ¹æ®è‡ªå·±æ¨¡å‹çš„è¾“å‡ºè·¯å¾„è¿›è¡Œæ›´æ”¹
!paddlex --export_inference --model_dir=output/mobilenetv3_large_ssld/best_model --save_dir=inference_model
```

## å…­ã€è¡¥å……è¯´æ˜

* æ­¤ç‰ˆæœ¬åªæ˜¯ç”¨PaddleXè·‘é€šäº†å›¾åƒåˆ†ç±»ä»»åŠ¡ï¼Œå…³äºæ¨¡å‹ä¼˜åŒ–å’Œåç»­éƒ¨ç½²çš„éƒ¨åˆ†æœ‰å¾…æ›´æ–°ã€‚
* æœ¬é¡¹ç›®å‚è€ƒPaddleXå®˜æ–¹æ–‡æ¡£å’Œå®˜æ–¹AI Studioä¸Šçš„é¡¹ç›®ã€‚
* å…³äºä½¿ç”¨PaddleXçš„æ„Ÿå—ï¼Œæœ¬äººè§‰å¾—è¿™ä¸ªå·¥å…·å¾ˆé€‚åˆå„ä½æœ‰åˆ›æ„çš„å¼€å‘è€…è¿›è¡Œå¿«é€Ÿå¼€å‘ï¼Œå¤§å®¶å¯ä»¥ä½¿ç”¨è¯¥å·¥å…·å®Œæˆè‡ªå·±çš„åˆ›æ„ã€‚
* å…³äºæœ¬é¡¹ç›®ä½¿ç”¨PaddleXé‡åˆ°çš„é—®é¢˜å¤šä¸ºå†…å­˜æº¢å‡ºï¼Œå¤§å®¶å¯ä»¥å°è¯•é‡å¯ç¯å¢ƒé‡Šæ”¾å†…å­˜ä»¥è§£å†³é—®é¢˜
* å¤§å®¶å¦‚æœè¿è¡Œæ­¤é¡¹ç›®æœ‰ä»€ä¹ˆé—®é¢˜æ¬¢è¿è¯„è®ºäº¤æµ=v=

## ä¸ªäººç®€ä»‹

> ä½œè€…ï¼šåˆ˜å»·æ¥ 


> ä¸œåŒ—å¤§å­¦ç§¦çš‡å²›åˆ†æ ¡2019çº§è½¦è¾†å·¥ç¨‹æœ¬ç§‘ç”Ÿ


> æ„Ÿå…´è¶£æ–¹å‘ï¼šè®¡ç®—æœºè§†è§‰ã€æ·±åº¦å­¦ä¹ 


> æˆ‘åœ¨[AI Studio](https://aistudio.baidu.com/aistudio/personalcenter/thirdview/537248)ä¸Šè·å¾—é»„é‡‘ç­‰çº§ï¼Œç‚¹äº®8ä¸ªå¾½ç« ï¼Œæ¥äº’å…³å‘€~ 
